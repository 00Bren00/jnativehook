<?xml version="1.0" encoding="UTF-8"?>

<project default="all" basedir="." xmlns:cpptasks="antlib:net.sf.antcontrib.cpptasks">
	<property environment="os"/>
	<property environment="env"/>
	
	<!-- Project Settings -->
	<property name="project.name"		value="JNativeHook"/>
	<property name="project.vendor" 	value="1stleg Development"/>
	<property name="project.version"	value="0.9.139"/>
	
	<!-- Path Settings -->
	<property name="dir.src" value="${basedir}/src"/>
	<property name="dir.dist" value="${basedir}/dist"/>
	
	<property name="dir.jar" value="${dir.dist}/jar"/>
	<property name="dir.lib" value="${dir.src}/org/jnativehook/lib"/>
	
	<property name="dir.class" value="${basedir}/bin"/>
	<property name="dir.obj" value="${basedir}/bin/obj"/>
	
	<target name="configure">
		<delete file="build.properties" verbose="true" failonerror="false"/>
		
		<echo>Checking environment sanity...</echo>
		<!-- Try to locate the include folder for java headers -->
		<condition property="javac.include" value="${os.JAVA_HOME}${file.separator}include">
			<and>
				<not>
					<isset property="javac.include"/>
				</not>
				
				<available file="${os.JAVA_HOME}/include" type="dir"/>
			</and>
		</condition>
		<condition property="javac.include" value="${java.home}${file.separator}..${file.separator}include">
			<and>
				<not>
					<isset property="javac.include"/>
				</not>
				
				<available file="${java.home}/../include" type="dir"/>
			</and>
		</condition>
		<fail unless="javac.include" message="Could not determine javac.include location.  Please set your JAVA_HOME environment variable or manually specify your javac.include location."/>
		<echo>Found java include location: ${javac.include}</echo>
		
		
		<!-- Figure out of the system arch is supported -->
		<condition property="gcc.arch" value="i586">
			<and>
				<not>
					<isset property="gcc.arch"/>
				</not>
				
				<or>
					<os arch="x86"/>
					<os arch="i386"/>
					<os arch="i486"/>
					<os arch="i586"/>
					<os arch="i686"/>
				</or>
			</and>
		</condition>
		<condition property="gcc.arch" value="k8">
			<and>
				<not>
					<isset property="gcc.arch"/>
				</not>
				
				<or>
					<os arch="x86_64"/>
					<os arch="amd64"/>
					<os arch="k8"/>
				</or>
			</and>
		</condition>
		<condition property="gcc.arch" value="powerpc">
			<and>
				<not>
					<isset property="gcc.arch"/>
				</not>
				
				<or>
					<os arch="ppc"/>
					<os arch="PowerPC"/>
				</or>
			</and>
		</condition>
		<condition property="gcc.arch" value="powerpc64">
			<and>
				<not>
					<isset property="gcc.arch"/>
				</not>
				
				<or>
					<os arch="ppc64"/>
					<os arch="PowerPC64"/>
				</or>
			</and>
		</condition>
		<fail unless="gcc.arch" message="The ${os.arch} architecture is not currently supported."/>
		<echo>Compatible system architecture: ${gcc.arch}</echo>
		
		<!-- Set 32 or 64 bit flag -->
		<condition property="gcc.arch.model" value="${sun.arch.data.model}">
			<not>
				<isset property="gcc.arch.model"/>
			</not>
		</condition>
		<echo>System architecture data model: ${gcc.arch.model} bit</echo>
		<!-- echo>${sun.cpu.endian}</echo -->
		
		
		<!-- Set the project debug flag -->
		<condition property="project.debug" value="true" else="false">
			<and>
				<isset property="project.debug"/>
				<equals arg1="${project.debug}" arg2="true" casesensitive="false" trim="false"/>
				<equals arg1="${project.debug}" arg2="yes" casesensitive="false" trim="false"/>
			</and>
		</condition>
		<echo>Debug Mode: ${project.debug}</echo>
		
		<!-- Determin the os family -->
		<condition property="gcc.os" value="windows">
			<or>
				<os family="winnt" name="Windows 2000"/>
				<os family="winnt" name="Windows XP"/>
				<os family="winnt" name="Windows 2003"/>
				<os family="winnt" name="Windows Vista"/>
				<os family="winnt" name="Windows 2007"/>
				<os family="winnt" name="Windows 7"/>
			</or>
		</condition>
		<condition property="gcc.os" value="osx">
			<and>
				<os family="mac"/>
				<os family="unix"/>
			</and>
		</condition>
		<condition property="gcc.os" value="linux">
			<os family="unix" name="Linux"/>
		</condition>
		<condition property="gcc.os" value="freebsd">
			<os family="unix" name="FreeBSD"/>
		</condition>
		<condition property="gcc.os" value="solaris">
			<or>
				<os family="unix" name="Solaris"/>
				<os family="unix" name="SunOS"/>
			</or>
		</condition>
		<fail unless="gcc.os" message="The ${os.name} ${os.version} opperating system is not currently supported."/>
		<echo>Opperating System: ${os.name} ${os.version} (${gcc.os})</echo>
		
		<propertyfile file="build.properties" comment="auto-generated by ant configure">
			<entry key="project.debug"			value="${project.debug}"/>
			<entry key="javac.fork"				value="yes"/>
			<entry key="javac.target"			value="${ant.java.version}"/>
			<entry key="javac.include" 			value="${javac.include}"/>
			<entry key="gcc.arch" 				value="${gcc.arch}"/>
			<entry key="gcc.arch.model"			value="${gcc.arch.model}"/>
			<entry key="gcc.os"					value="${gcc.os}"/>
		</propertyfile>
	</target>
	
	<target name="clean" description="prepares the environment">
		<echo>Cleaning old build structure...</echo>
		<delete includeemptydirs="false" verbose="true">
			<fileset dir="${dir.class}" includes="**/*"/>
		</delete>
	</target>
	
	
	<target name="compile" depends="" description="Compiles the classes">
		<property file="build.properties"/>
		<fail message="Your build.properties file appears to be incomplete.  Please verify your settings or run the ant configure task.">
			<condition>
				<not>
					<and>
						<isset property="project.debug"/>
						<isset property="javac.fork"/>
						<isset property="javac.target"/>
						<isset property="javac.include"/>
						<isset property="gcc.arch"/>
						<isset property="gcc.arch.model"/>
						<isset property="gcc.os"/>
					</and>
				</not>
			</condition>
		</fail>
		
		
		<!-- Figure out the os family -->
		<condition property="gcc.os.isWindows" value="true">
			<equals arg1="${gcc.os}" arg2="windows" casesensitive="false" trim="true"/>
		</condition>
		<condition property="gcc.os.isUnix" value="true">
			<or>
				<equals arg1="${gcc.os}" arg2="linux" casesensitive="false" trim="true"/>
				<equals arg1="${gcc.os}" arg2="freebsd" casesensitive="false" trim="true"/>
				<equals arg1="${gcc.os}" arg2="solaris" casesensitive="false" trim="true"/>
			</or>
		</condition>
		<condition property="gcc.os.isMac" value="true">
			<equals arg1="${gcc.os}" arg2="osx" casesensitive="false" trim="true"/>
		</condition>
		
		
		<!-- Check for debug -->
		<condition property="project.isDebug" value="true">
			<istrue value="${project.debug}"/>
		</condition>
		
		
		<!-- Set the system arch name -->
		<condition property="sys.arch" value="i586">
			<equals arg1="${gcc.arch}" arg2="i586" casesensitive="false" trim="true"/>
		</condition>
		<condition property="sys.arch" value="amd64">
			<equals arg1="${gcc.arch}" arg2="k8" casesensitive="false" trim="true"/>
		</condition>
		<condition property="sys.arch" value="ppc">
			<equals arg1="${gcc.arch}" arg2="powerpc" casesensitive="false" trim="true"/>
		</condition>
		<condition property="sys.arch" value="ppc64">
			<equals arg1="${gcc.arch}" arg2="powerpc64" casesensitive="false" trim="true"/>
		</condition>
		<condition property="sys.arch.isx86" value="true">
			<or>
				<equals arg1="${gcc.arch}" arg2="i586" casesensitive="false" trim="true"/>
				<equals arg1="${gcc.arch}" arg2="amd64" casesensitive="false" trim="true"/>
			</or>
		</condition>
		
		<!-- Set the system os name -->
		<condition property="sys.name" value="linux">
			<equals arg1="${os.name}" arg2="Linux" casesensitive="false" trim="true"/>
		</condition>
		<condition property="sys.name" value="osx">
			<equals arg1="${os.name}" arg2="Mac OS X" casesensitive="false" trim="true"/>
		</condition>
		<condition property="sys.name" value="windows">
			<or>
				<equals arg1="${os.name}" arg2="Windows 2000" casesensitive="false" trim="true"/>
				<equals arg1="${os.name}" arg2="Windows XP" casesensitive="false" trim="true"/>
				<equals arg1="${os.name}" arg2="Windows 2003" casesensitive="false" trim="true"/>
				<equals arg1="${os.name}" arg2="Windows Vista" casesensitive="false" trim="true"/>
				<equals arg1="${os.name}" arg2="Windows 7" casesensitive="false" trim="true"/>
			</or>
		</condition>
		<condition property="sys.name" value="solaris">
			<or>
				<equals arg1="${os.name}" arg2="Solaris" casesensitive="false" trim="true"/>
				<equals arg1="${os.name}" arg2="SunOS" casesensitive="false" trim="true"/>
			</or>
		</condition>
		<condition property="sys.name" value="freebsd">
			<equals arg1="${os.name}" arg2="FreeBSD" casesensitive="false" trim="true"/>
		</condition>
		
		<fail message="The ${os.name} opperating system is not currently supported.">
			<condition>
				<or>
					<not>
						<or>
							<isset property="gcc.os.isWindows"/>
							<isset property="gcc.os.isUnix"/>
							<isset property="gcc.os.isMac"/>
						</or>
					</not>
					<not>
						<isset property="sys.name"/>
					</not>
				</or>
			</condition>
		</fail>
		
		
		
		
		<echo>Compiling java source...</echo>
		<mkdir dir="${dir.dist}"/>
		<mkdir dir="${dir.class}"/>
		<path id="classpath">
			<pathelement location="${dir.class}"/>
			<!--
			<fileset dir="${project.lib}">
				<include name="*.jar"/>
			</fileset>
			-->
		</path>
		<javac srcdir="${dir.src}"
			destdir="${dir.class}"
			classpathref="classpath"
			debug="${project.debug}"
			deprecation="false"
			source="${javac.target}"
			target="${javac.target}"
		/>
		
		<echo>Compiling C source...</echo>
		<mkdir dir="${dir.obj}"/>
		<mkdir dir="${dir.lib}/${sys.name}-${sys.arch}"/>
		
		<!-- cpptasks are nice but there are alot of bugs, replace with exec and apply
		<apply executable="gcc" osfamily="winnt" parallel="true">
			<fileset dir="${dir.src}/org/jnativehook/c_source">
				<include name="windows/*.c"/>
			</fileset>
		</apply>
		-->
		
		<!-- runtime="dynamic" -->
		<cpptasks:cc
			multithreaded="false"
			optimize="speed"
			
			outtype="shared"
			link="shared"
			
			outfile="${dir.lib}/${sys.name}-${sys.arch}/JNativeHook"
			objdir="${dir.obj}"
			
			debug="${project.debug}"
			warnings="diagnostic"
		>
			<compiler name="gcc">
				<includepath location="${dir.src}/org/jnativehook/c_source"/>
				<includepath>
					<dirset dir="${javac.include}">
						<include name="**"/>
					</dirset>
				</includepath>
				
				<includepath location="/usr/include" if="gcc.os.isUnix"/>
				<includepath location="/usr/local/include" if="gcc.os.isUnix"/>
				
				<fileset dir="${dir.src}/org/jnativehook/c_source">
					<include name="windows/*.c" if="gcc.os.isWindows"/>
					<include name="unix/*.c" if="gcc.os.isUnix"/>
					<include name="osx/*.c" if="gcc.os.isMac"/>
				</fileset>
				
				<compilerarg value="-march=${gcc.arch}"/>
				<compilerarg value="-m${gcc.arch.model}"/>
				
				<compilerarg value="-fPIC" unless="gcc.os.isWindows"/>
				<compilerarg value="-Wall"/>
				<compilerarg value="-O3"/>
				<compilerarg value="-fno-strict-aliasing"/>
				<compilerarg value="-lX11" if="gcc.os.isUnix"/>
				<compilerarg value="-DDEBUG" if="project.isDebug"/>

				<!-- compilerarg value="-v"/-->
			</compiler>
			
			<linker name="gcc">
				<!-- linkerarg value="-W/dll" if="gcc.os.isWindows"/ -->
				
				<!--
				<linkerarg value="-m${gcc.arch.model}"/>
				<linkerarg value="-march=${gcc.arch}"/>
				<linkerarg value="-fPIC"/>
				<linkerarg value="-Wall"/>
				<linkerarg value="-O3"/>
				<linkerarg value="-fno-strict-aliasing"/>
				-->
				
				<linkerarg value="-lX11" if="gcc.os.isUnix"/>
				<linkerarg value="-L/usr/lib" if="gcc.os.isUnix"/>
				<linkerarg value="-L/usr/local/lib" if="gcc.os.isUnix"/>
			</linker>
			
			
			<versioninfo
				companyname="${project.vendor}"
				productname="${project.name}"
				productversion="${project.version}"
			/>
		</cpptasks:cc>
		
		<echo>Copying libs...</echo>
		<mkdir dir="${dir.class}/org/jnativehook/lib"/>
		<copy overwrite="true" todir="${dir.class}/org/jnativehook/lib">
			<fileset dir="${dir.lib}" includes="**/*" excludes="**/history.xml"/>
		</copy>
		
		<!-- Fix for cpptasks on windows borked output -->
		<move 
			file="${dir.lib}/${sys.name}-${sys.arch}/libJNativeHook.so" 
			tofile="${dir.lib}/${sys.name}-${sys.arch}/JNativeHook.dll" 
			failonerror="false"
			overwrite="true"
		/>
		
		<!-- Fix for ant not knowing how to move a file -->
		<delete file="${dir.lib}/${sys.name}-${sys.arch}/libJNativeHook.so"/>
	</target>
	
	<target name="jar" depends="compile" description="Builds the required jar binaries">
		<echo>Creating JNativeHook.jar...</echo>
		<mkdir dir="${dir.jar}"/>
		<jar jarfile="${dir.jar}/JNativeHook.jar" basedir="${dir.class}">
			<include name="org/jnativehook/keyboard/**"/>
			<include name="org/jnativehook/**"/>
			<exclude name="org/jnativehook/c_source/**"/>
			<exclude name="org/jnativehook/lib/**/history.xml"/>
			<!-- <exclude name="org/jnativehook/Driver.class"/> -->
			<manifest>
				<attribute name="Main-Class" value="org.jnativehook.example.NativeHookDemo"/>
				<section name="org/jnativehook">
					<attribute name="Implementation-Title" value="${project.name} Library"/>
					<attribute name="Implementation-Version" value="${project.version}"/> 
					<attribute name="Implementation-Vendor" value="${project.vendor}"/>
				</section>
			</manifest>
		</jar>
	</target>
	
	
	<target name="package" depends="jar" description="Builds the server binaries">
		<!-- Copy Files To Dist Locations -->
		<echo>Creating Distribution Archive...</echo>
		<zip destfile="${dir.dist}/JNativeGrab.zip" duplicate="add" level="9">
			<zipfileset dir="${dir.jar}" includes="*.jar"/>
		</zip>
		
		<tar destfile="${dir.dist}/JNativeGrab.tar.gz" compression="gzip">
			<tarfileset dir="${dir.jar}" includes="*.jar"/>
		</tar>
		
		<tar destfile="${dir.dist}/JNativeGrab.tar.bz2" compression="bzip2">
			<tarfileset dir="${dir.jar}" includes="*.jar"/>
		</tar>
	</target>
	
	
	<target name="all" depends="package" description="builds all targets">
	</target>
</project>
