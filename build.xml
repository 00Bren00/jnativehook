<?xml version="1.0" encoding="UTF-8"?>

<project default="all" basedir="." xmlns:cpptasks="antlib:net.sf.antcontrib.cpptasks">
	<property file="build.properties"/>
	<property environment="os"/>
	
	<!-- Project Settings -->
	<property name="project.name" value="JNativeGrab"/>
	<property name="project.vendor" value="1stleg Development"/>
	<property name="project.version" value="0.9.93"/>
	<property name="project.src" value="src"/>
	
	
	<!-- Path Settings -->
	<property name="dir.dist" value="dist"/>
	<property name="dir.classes" value="${dir.dist}/build/classes"/>
	<property name="dir.jars" value="${dir.dist}/build/jars"/>
	<property name="dir.objs" value="${dir.dist}/build/objs"/>
	
	
	<!-- Compiler Settings -->
	<property name="javac.optimize" value="true"/>
	<property name="javac.source" value="1.6"/>
	<property name="javac.target" value="1.6"/>
	
	<target name="config_gcc">
		<echo>Determining gcc settings for ${os.name} ${os.arch}</echo>
		
		<!-- determin the march to use -->
		<condition property="gcc.arch" value="i586">
			<and>
				<not>
					<isset property="gcc.arch"/>
				</not>
				
				<or>
					<os arch="x86"/>
					<os arch="i386"/>
					<os arch="i486"/>
					<os arch="i586"/>
					<os arch="i686"/>
				</or>
			</and>
		</condition>
		
		<condition property="gcc.arch" value="k8">
			<and>
				<not>
					<isset property="gcc.arch"/>
				</not>
				
				<or>
					<os arch="x86_64"/>
					<os arch="amd64"/>
					<os arch="k8"/>
				</or>
			</and>
		</condition>
		
		<!-- Stop here if we could not find a supported arch -->
		<fail unless="gcc.arch" message="The ${os.arch} architecture is not currently supported."/>
		
		<!-- Set 32 or 64 bit flag -->
		<condition property="gcc.bits" value="32" else="64">
			<equals arg1="${gcc.arch}" arg2="i586" casesensitive="false"/>
		</condition>
		
		<!-- Set the gcc debug flag ONLY IF debug is true, unset implies false -->
		<condition property="gcc.debug" value="true">
			<istrue value="${project.debug}"/>
		</condition>
	</target>
	
	<target name="clean" description="prepares the environment">
		<echo>Cleaning old build structure...</echo>
		<delete includeemptydirs="true">
			<fileset dir="${dir.dist}" includes="**/*"/>
		</delete>
		
		
		<echo>Creating build folders...</echo>
		<mkdir dir="${dir.dist}"/>
		<mkdir dir="${dir.classes}"/>
		<mkdir dir="${dir.jars}"/>
		<mkdir dir="${dir.objs}"/>
		
		<!-- Create Linux Branch -->
		<mkdir dir="${dir.dist}/Linux/x86_32"/>
		<mkdir dir="${dir.dist}/Linux/x86_64"/>
		
		<!-- Create OSX Branch -->
		<mkdir dir="${dir.dist}/OSX"/>
		
		<!-- Create Windows Branch -->
		<mkdir dir="${dir.dist}/Windows/x86_32"/>
		
		<path id="classpath">
			<pathelement location="${dir.classes}"/>
			<!--
			<fileset dir="${project.lib}">
				<include name="*.jar"/>
			</fileset>
			-->
		</path>
	</target>
	
	
	<target name="compile" depends="clean,config_gcc" description="Compiles the classes">
		<echo>Compiling ${project.keyboard.name}...</echo>
		<javac srcdir="${project.src}"
			destdir="${dir.classes}"
			classpathref="classpath"
			debug="${project.debug}"
			optimize="${javac.optimize}"
			deprecation="false"
			source="${javac.source}"
			target="${javac.target}"
		/>
		
		<echo>Compiling C source...</echo>
		<cpptasks:cc
			outtype="shared"
			outfile="${dir.dist}/JNativeGrab_Keyboard"
			objdir="${dir.objs}"
			
			debug="${project.debug}"
			warnings="diagnostic"
		>
			<!-- compiler name="gcc"
			multithreaded="true"
			optimize="speed"
			link="shared" 
			outtype="shared"
			outfile="${dir.dist}/JNativeGrab_Keyboard"
			objdir="${dir.objs}"
			
			
			 -->
				<includepath location="${basedir}/src/org/jnativegrab/keyboard/c_source"/>
				<includepath location="${os.JAVA_HOME}/include"/>
				<includepath location="${os.JAVA_HOME}/include/linux"/>
				
				<fileset dir="${basedir}/src/org/jnativegrab/keyboard/c_source/linux">
					<include name="*.h"/>
					<include name="*.c"/>
				</fileset>
				<fileset dir="${basedir}/src/org/jnativegrab/keyboard/c_source/include">
								<include name="*.h"/>
								<include name="*.c"/>
							</fileset>
				<compilerarg value="-m${gcc.bits}"/>
				<compilerarg value="-march=${gcc.arch}"/>
				<compilerarg value="-fPIC"/>
				<compilerarg value="-Wall"/>
				<compilerarg value="-O3"/>
				<compilerarg value="-fno-strict-aliasing"/>
				<compilerarg value="-lX11"/>
				<compilerarg value="-DDEBUG" if="${gcc.debug}"/>
			<!-- /compiler -->

			<!-- versioninfo
				companyname="${project.vendor}"
				productname="${project.keyboard.name}"
				productversion="${project.keyboard.version}"
			/-->
		</cpptasks:cc>
	</target>
	
	
	<target name="jar" depends="compile" description="Builds the required jar binaries">
		<!--
		<copy overwrite="true" todir="${project.build}/${dir.images}">
			<fileset dir="${project.web}/${dir.images}">
				<include name="*.jpg"/>
				<include name="*.gif"/>
				<include name="*.png"/>
			</fileset>
		</copy>
		-->
		
		
		<echo>Creating JNativeGrab.jar...</echo>
		<jar jarfile="${dir.jars}/JNativeGrab.jar" basedir="${dir.classes}">
			<include name="org/jnativegrab/keyboard/**"/>
			<include name="org/jnativegrab/**"/>
			<!-- <exclude name="org/jnativegrab/Driver.class"/> -->
			<manifest>
				<attribute name="Main-Class" value="org.jnativegrab.Driver"/>
				<section name="org/jnativegrab">
					<attribute name="Implementation-Title" value="${project.name} Library"/>
					<attribute name="Implementation-Version" value="${project.version}"/> 
					<attribute name="Implementation-Vendor" value="${project.vendor}"/>
				</section>
			</manifest>
		</jar>
		
		
		<!--
		<echo>Creating client init script.</echo>
		<copy overwrite="true" file="${project.src}/org/dotnative/globalkeylistener/cpp_source/Linux/x86_32/libGlobalKeyListener.so" todir="${dir.key}"/>
		-->
	</target>
	
	
	<target name="package" depends="jar" description="Builds the server binaries">
		<!-- Copy Files To Dist Locations -->
		<echo>Copying files...</echo>
		<copy 
			overwrite="true" 
			file="${dir.jars}/JNativeGrab.jar" 
			todir="${dir.dist}"
		/>
	</target>
	
	
	<target name="all" depends="package" description="builds all targets">
	</target>
</project>
